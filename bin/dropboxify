#!/usr/bin/env bash

DROPBOX_FOLDER=~/Dropbox

for source in "$@"; do
    # Normalise to the full path for now
    source_path=`perl -e 'use Cwd "abs_path";print abs_path(shift)' ${source}`
    
    # Skip files we don't know how to handle yet
    if [[ $source_path != ${HOME}* ]]; then
        echo "File ${source_path} is not in ${HOME}, skipping."
        continue
    # Skip non-existant files
    elif [ ! -e "$source_path" ]; then
        echo "File ${source_path} does not exist, skipping."
        continue
    fi
    
    # Ensure the target directory exists
    # TODO: Make this clearer
    target_dir=`echo $source_path | sed -e 's_/[^/]*$__'`
    mkdir -p "${DROPBOX_FOLDER}${target_dir#$HOME}"
    
    # TODO: Get dropbox directory programmatically
    mv "$source_path" "${DROPBOX_FOLDER}${source_path#$HOME}"
    
    # Link the original location back to Dropbox
    ln -s "${DROPBOX_FOLDER}${source_path#$HOME}" "$source_path"
    
    echo "Moved ${source} to ${DROPBOX_FOLDER}"
done